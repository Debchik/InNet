# YooKassa integration (token packs)

InNet перешёл на модель pay-as-you-go: 20 контактов и базовые факты бесплатны, всё сверх оплачивается
токенами. Этот документ описывает, как будет работать покупка пакетов токенов через YooKassa и какие
заглушки сейчас используются на фронтенде.

## Что уже реализовано

- На странице `/app/upgrade` пользователь выбирает пакет токенов. При клике вызывается
  `simulateTokenPurchase(packId)` — функция имитирует платёж и просто пополняет баланс в `localStorage`.
- Стоимость действий зашита в `lib/tokens.ts` (`TOKEN_ACTIONS_LIST`). Эти значения показываются на лендинге,
  в оферте и в самом кошельке.
- Лимиты бесплатного плана берутся из `PLAN_ENTITLEMENTS.free`.

## Планируемая интеграция с YooKassa

1. Клиент отправляет `POST /api/payments/create` с идентификатором пакета (`starter-40`, `networker-120`, и т. д.).
2. Сервер создаёт платёж в YooKassa и возвращает `paymentId` + `confirmationUrl`.
3. После подтверждения оплаты серверный вебхук (`/api/payments/webhook`) начисляет токены:
   - Находит пользователя по `metadata.userId`.
   - Добавляет `pack.tokens + pack.bonusTokens` к балансу в Supabase.
   - Возвращает статус `succeeded`, чтобы фронтенд обновил локальный кэш.
4. Клиент опрашивает `/api/payments/status?paymentId=...` до тех пор, пока вебхук не подтвердит зачисление.

## Переменные окружения

| Переменная              | Значение                                                    |
|------------------------|-------------------------------------------------------------|
| `YOOKASSA_SHOP_ID`     | Идентификатор магазина                                      |
| `YOOKASSA_SECRET_KEY`  | Секретный ключ для подписи запросов и проверки вебхуков     |
| `NEXT_PUBLIC_SITE_URL` | Базовый URL (используется в `return_url` при оплате пакета) |

## Важные детали синхронизации

- Баланс токенов пока хранится только локально. После подключения YooKassa данные нужно синхронизировать
  с Supabase (`profile.tokens`). При ошибке синхронизации фронтенд должен показать уведомление и предложить
  повторить попытку.
- Вебхук обязан проверять сумму платежа против ожидаемой цены пакета, иначе пользователь сможет подменить
  стоимость.
- При возврате средств надо списывать токены в обратном порядке (например, возвращаем `networker-120` —
  уменьшаем баланс на 132 токена и помечаем операцию в журнале).

## Тестовый режим

Пока YooKassa не подключена, ничего делать не нужно — заглушка `simulateTokenPurchase` уже позволяет тестировать
экономику и UX. Перед релизом:

1. Реализуйте настоящие API-роуты `/api/payments/create|status|webhook`.
2. Замените вызов `simulateTokenPurchase` в `pages/app/upgrade.tsx` на реальный `startPayment`.
3. Убедитесь, что `TOKEN_PACKS` в `lib/tokens.ts` соответствует ценам в YooKassa.
